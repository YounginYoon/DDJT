<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./assets/main.css" />
    <link rel="stylesheet" href="./assets/style.css" />

    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <title>프로필</title>
    <style>
      * {
        font-family: 'Noto Sans KR', sans-serif;
      }
      .rating {
        width: 60%;
        height: 80px;
        /*
        border: 1px solid red;
        */
        text-align: center;
        margin: 3% auto 0;
      }
      .parent {
        /*
        background-color: rgb(255, 238, 236);
        */
        width: 800px;
        margin: 10px auto;
        margin-top: 100px;
        display: flex;
      }
      .main {
        flex: 1;
        margin: 0px 5%;
      }
      .detail {
        width: 200px;
      }

      .profile_img_prev {
        width: 200px;
        float: right;
      }

      .nav-link {
        color: rgb(73, 73, 73);
        font-family: 'Noto Sans KR', sans-serif;
        font-size: large;
        font-weight: bold;
        text-decoration-line: none;
      }
      .nav-item {
        margin-top: 8px;
      }

      #input-file-button {
        width: 60px;
        height: 20px;
        padding: 2px;
        background-color: rgb(186, 186, 186);
        border-radius: 4px;
        color: white;
        cursor: pointer;
        margin-top: 5px;
        text-align: center;
        font-size: smaller;
        font-weight: bold;
        font-size: 10px;
        float: right;
      }
    </style>
  </head>
  <body>
    <!-- 네비바 start-->
    <div class="container">
      <ul id="nav2" class="nav justify-content-around bg-white">
        <li class="nav-item-title">
          <a
            class="nav-link active"
            href="index.html"
            style="
              color: darkorange;
              font-family: 'Jua', sans-serif;
              font-size: xx-large;
              text-decoration-line: none;
            "
            >ㄷㄸㅈㅌ</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">경매</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">교환</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">커뮤니티</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">고객센터</a>
        </li>
        <!-- <li class="nav-item">
          <a
            class="nav-link"
            href=""
            style="color: darkgray"
            id="profile_LogoutButton"
            >로그아웃</a
          >
        </li> -->

        <form
          class="navbar-form pull-right"
          role="search"
          style="margin-top: 10px"
        >
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Search" />
            <div class="input-group-btn">
              <button class="btn btn-outline-success" type="submit">
                Search
              </button>
            </div>
          </div>
        </form>
      </ul>
    </div>
    <!-- 네비바 end-->

    <div class="parent">
      <div class="profile">
        <div class="profile_img_prev">
          <img id="previewImg" width="200" style="border-radius: 20px" />
          <label id="input-file-button" for="profile_img">프로필 변경</label>
          <input
            type="file"
            id="profile_img"
            accept="image/*"
            style="display: none"
          />
        </div>

        <div class="detail" style="margin-top: 10px">
          <div style="display: inline-flex">
            <h6
              id="profile_nickname"
              style="
                font-weight: lighter;
                margin-bottom: 15px;
                font-family: 'Jua', sans-serif;
              "
            >
              닉네임
            </h6>
            <img src="./assets/gloves.png" width="20px" height="20px" />
          </div>
          <div class="profile_introduce">
            <div style="width: auto; display: flex">
              <h9
                style="
                  font-weight: lighter;
                  color: darkgreen;
                  font-family: 'Jua', sans-serif;
                "
              >
                ▶ 자기소개
              </h9>
              <button
                id="profile_edit_btn"
                type="submit"
                onclick="window.open('edit_text.html', '수정하기', 'width=500, height=250')"
              >
                edit
              </button>
            </div>
            <h9 id="intro_Text"></h9>
          </div>
          <div
            style="
              font-weight: lighter;
              color: darkgreen;
              font-family: 'Jua', sans-serif;
              margin-top: 15px;
            "
          >
            ▶ 포인트
          </div>
          <div style="list-style: none">500 P</div>
        </div>
      </div>
      <hr style="margin-left: 10px" />
      <div class="main">
        <!-- 거래 내역 표시-->
        <div>
          <h4
            id="auction_text"
            style="font-family: 'Jua', sans-serif; color: darkorange"
          ></h4>
          <h3>☞ 8.6점 ☜</h3>
        </div>
        <br />
        <section>
          <fieldset style="border-radius: 10px; width: 500px">
            <legend
              style="text-align: center; font-weight: bold; font-size: large"
            >
              거래 내역
            </legend>
            <ul class="trans_list">
              <li>[몬스타엑스] REASON 셔누 포카 교환</li>
              <li>[몬스타엑스] FATAL LOVE 기현, 형원 포카 교환</li>
              <li>[몬스타엑스] 아이엠 팬콘 장미반지 양도</li>
              <li>[슈퍼주니어] 은혁 팬콘 증사 양도</li>
            </ul>
          </fieldset>
        </section>
        <!-- 등급 xp -->
        <br />
        <div
          style="
            border: 1px solid black;
            width: 500px;
            height: 5%;
            margin-top: 10%;
          "
        >
          등급 xp 내가 하자했지만 제일 어렵고 뭐가 뭔지 모르겠음
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.6.3.min.js"
      integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
      crossorigin="anonymous"
    ></script>

    <script>
      var firebaseConfig = {
        apiKey: 'AIzaSyAj-l4QrI9d0ax3Qv4nPBiCVfWkqre9XYA',
        authDomain: 'capstone2023-57a1c.firebaseapp.com',
        databaseURL: 'https://capstone2023-57a1c-default-rtdb.firebaseio.com',
        projectId: 'capstone2023-57a1c',
        storageBucket: 'capstone2023-57a1c.appspot.com',
        messagingSenderId: '475497513021',
        appId: '1:475497513021:web:d66a2ba67eeed6d031ea54',
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      const db = firebase.firestore();
      const storage = firebase.storage();
      var user_info = sessionStorage.getItem('user');
      const fileInput = document.getElementById('profile_img');

      // nickname 띄우기
      firebase.auth().onAuthStateChanged((user) => {
        if (user_info) {
          var user_uid = JSON.parse(user_info).uid;
          var auction_text_html =
            '[ ' + JSON.parse(user_info).displayName + ' ] 님의 거래점수는?';
          console.log(auction_text_html);
          $('#profile_nickname').html(JSON.parse(user_info).displayName);
          $('#auction_text').html(auction_text_html);

          //프리뷰 이미지 띄우기
          if (user.photoURL) {
            document.getElementById('previewImg').src = user.photoURL;
          }
          // else {
          //   var basic_url =
          //     'https://firebasestorage.googleapis.com/v0/b/capstone2023-57a1c.appspot.com/o/profile_image%2Fbasic_profile_img%2F%EC%9C%A0%ED%8A%9C%EB%B8%8C_%EA%B8%B0%EB%B3%B8%ED%94%84%EB%A1%9C%ED%95%84_%ED%95%98%EB%8A%98%EC%83%89.jpg?alt=media&token=fe7d1412-e30a-4396-9034-6b9d2f4a3781';
          //   user.updateProfile({ photoURL: basic_url });
          //   document.getElementById('previewImg').src = user.photoURL;
          //   //window.location.reload();
          // }
          // profile img upload to Firebase
          fileInput.onchange = () => {
            const selectedFile = fileInput.files[0];
            console.log(JSON.parse(user_info).uid);
            var storageRef = storage.ref();
            var savingPath = storageRef.child(
              'profile_image/' +
                JSON.parse(user_info).uid +
                '/' +
                selectedFile.name
            );
            var upload = savingPath.put(selectedFile);

            upload.on(
              'state_changed',
              // 변화시 동작하는 함수
              null,
              //에러시 동작하는 함수
              (error) => {
                console.error('실패사유는', error);
              },
              // 성공시 동작하는 함수
              () => {
                upload.snapshot.ref.getDownloadURL().then((url) => {
                  console.log('Success! upload path: ', url);

                  var profile_url = { 프로필: url };
                  db.collection('users').doc(user_uid).update(profile_url);
                  user.updateProfile({ photoURL: url });
                  window.location.reload();
                });
              }
            );
          };
        }

        // 자기소개 글 파이어베이스에서 받아오기
        db.collection('users')
          .doc(user.uid)
          .get()
          .then((result) => {
            if (result.data().소개글) {
              console.log(result.data().소개글);
              document.getElementById('intro_Text').innerText =
                result.data().소개글;
              if (document.getElementById('intro_Text').innerText.length > 20)
                document.getElementById('intro_Text').style.fontSize = '13px';
            } else {
              console.log('no 소개글 text');
            }
          })
          .catch((err) => {
            console.log(err);
          });
      });
    </script>
  </body>
</html>
